{"title":"Regressão linear","markdown":{"yaml":{"title":"Regressão linear","code-annotations":"hover","cache":true},"headingText":"Introdução","containsRefs":false,"markdown":"\n\n\n\n\nA regressão linear é uma técnica estatística que busca modelar a relação entre uma variável dependente e uma ou mais variáveis independentes. A regressão linear simples é utilizada quando temos apenas uma variável independente, enquanto a regressão linear múltipla é utilizada quando temos mais de uma variável independente.\n\nNesta aula, exploraremos:\n\n  - Como ajustar um modelo de regressão linear simples e múltipla no R.\n  \n  - Como extrair informações sobre o modelo ajustado.\n  \n  - Como visualizar o ajuste do modelo.\n  \n  - Como verificar os pressupostos da regressão linear.\n  \n  - Como extrair tabelas de regressão para apresentação dos resultados.\n  \n::: callout-warning\n\nO objetivo desta aula **não** é aprofundar nos conceitos teóricos da regressão linear, mas sim apresentar como ajustar e explorar funções que permitem ajustar modelos de regressão linear no R. Caso você tenha dúvidas sobre os conceitos teóricos, consulte os [materiais sugeridos no final desta aula](#sugest%C3%B5es-de-materiais).\n:::\n\n## Instalando pacotes\n\nPara esta aula, utilizaremos alguns pacotes do R, que talvez não tenham sido instalados anteriormente:\n\n```{r}\n#| eval: false\npacotes <- c(\"abjData\", \"broom\", \"car\", \"stargazer\", \"report\")\ninstall.packages(pacotes)\n```\n\n\n## Carregando pacotes\n\nVamos carregar o pacote `{ggplot2}`, que utilizamos anteriormente para elaborar gráficos:\n\n```{r}\n#| message: false\nlibrary(ggplot2)\n```\n\nO comando abaixo desabilita a notação científica no R, o que facilita a leitura dos resultados:\n\n```{r}\noptions(scipen = 999) \n```\n\n## Importando os dados\n\nNesta aula, utilizaremos os dados do [Programa das Nações Unidas para o Desenvolvimento (PNUD)](http://www.br.undp.org/content/brazil/pt/home/idh0/rankings/idhm-municipios-2010.html) sobre o Índice de Desenvolvimento Humano Municipal (IDHM) e suas dimensões para os municípios brasileiros em 2010. Esses dados estão disponíveis no pacote `abjData`.\n\nVamos filtrar os dados mais recentes disponíveis (censo de 2010) e salvar em um objeto chamado `pnud_muni_2010`:\n\n```{r}\npnud_muni_2010 <- abjData::pnud_muni |> \n dplyr::filter(ano == 2010) \n```\n\n**Obs:** O pacote `abjData` contém dados do PNUD para os anos de 1991, 2000 e 2010. Utilizamos apenas os dados de 2010 nesta aula, pois os dados não são independentes entre si. Se quisermos ajustar um modelo com dados de diferentes anos, seria necessário ajustar um modelo longitudinal (em painel), o que foge do escopo desta aula.\n\n### Dicionário dos dados\n\nA tabela `pnud_muni_2010` contém muitas variáveis, e alguns nomes não são muito descritivos. Podemos consultar o significado de cada variável consultando a tabela `pnud_siglas` do pacote `{abjData}`:\n\n```{r}\nnomes_col_pnud_muni_2010 <- abjData::pnud_siglas |> \n  dplyr::filter(sigla %in% names(pnud_muni_2010))\n\nnomes_col_pnud_muni_2010 |> \n  DT::datatable()\n```\n\n## Pergunta a ser explorada\n\nQueremos explorar a seguinte pergunta: **Dentre as variáveis a seguir, qual explica mais a mortalidade infantil?**\n  - `t_agua`: Percentual da população que vive em domicílios com água encanada.\n  - `rdpc`: Renda per capita.\n\n```{r}\nnomes_col_pnud_muni_2010 |> \n  dplyr::filter(sigla %in% c(\"mort5\", \"t_agua\", \"rdpc\")) |> \n  knitr::kable()\n```\n\n\n## Regressão linear simples\n\nExistem várias maneiras de ajustar um modelo de regressão linear no R: podemos usar funções do R base, ou funções de outros pacotes, como o `{fixest}`.\n\nVamos ajustar um modelo de regressão linear simples utilizando a função  função `lm()`, do R base.\n\nUma primeira variável que podemos explorar é o acesso à água encanada.\n\nVamos ajustar um modelo de regressão linear simples para investigar a relação entre a taxa de mortalidade infantil (até 5 anos de idade) (`mort5`) e o percentual da população que vive em domicílios com água encanada (`t_agua`) nos municípios brasileiros em 2010.\n\nEntão, temos que:\n\n- Variável dependente (`y`): `mort5`\n\n- Variável independente (`x`): `t_agua`\n\n### Visualizando a relação entre as variáveis\n\nPrimeiramente, podemos visualizar a relação entre as variáveis. Caso você não lembre como fazer isso, consulte a [aula sobre visualização de dados](07_visualizacao.qmd).\n\n```{r}\n#| label: lm-simples-relacao-variaveis\npnud_muni_2010 |> # <1>\n  ggplot() + # <2>\n  aes(x = t_agua, y = mort5) + # <3>\n  geom_point(alpha = 0.5) + # <4>\n  theme_light()\n```\n1. Utilizamos os dados do objeto `pnud_muni_2010`.\n2. Iniciamos um gráfico.\n3. Definimos as variáveis `x` e `y`.\n4. Adicionamos a geometria de pontos ao gráfico. O argumento `alpha = 0.5` define a transparência dos pontos em 50%.\n\n\n\n### Ajustando o modelo\n\nUma maneira é usar a função `lm()`, de *linear model* (modelo linear), para ajustar o modelo de regressão linear simples. Essa função recebe como argumentos a fórmula do modelo (`y ~ x`, lê-se `y` em função de `x`) e os dados (argumento `data`).\n\n\n```{r}\nmodelo_linear <- lm(mort5 ~ t_agua, data = pnud_muni_2010)\n```\n\n### Explorando o modelo ajustado\n\nPodemos explorar o resultado do modelo ajustado de várias formas!\n\nA função `summary()` nos fornece um resumo do modelo ajustado:\n\n```{r}\nsummary(modelo_linear)\n```\n\nPodemos extrair uma *tibble* com informações sobre o modelo ajustado utilizando as funções `tidy()` e `glance()` do pacote `{broom}`. A função `broom::tidy()` nos fornece informações sobre os coeficientes do modelo ajustado.\n\n```{r}\nbroom::tidy(modelo_linear) |> \n  knitr::kable()\n```\nOs resultados da função `broom::glance()` são relativos ao ajuste do modelo, sendo útil para comparar diferentes modelos.\n\n```{r}\nbroom::glance(modelo_linear)|> \n  knitr::kable()\n```\n\n\nA função `report::report()` nos fornece um relatório completo sobre o modelo ajustado:\n\n```{r}\nreport::report(modelo_linear) \n```\n\n\n\n### Interpretação dos resultados\n\nA equação ajustada é:\n\n\n$$\nmort5 = 44.23 - 0.27 \\times tagua\n$$\n- **Interpretação do Coeficiente de `t_agua`**: Para cada aumento de 1% no percentual de água encanada, espera-se uma redução de 0.27 na taxa de mortalidade infantil (por 1000 nascidos vivos).\n\n- **Interpretação do Intercepto**: Se o percentual de água encanada fosse 0, a mortalidade infantil seria de 44.23 por 1000 nascidos vivos. Este valor pode não ser relevante na prática, mas é útil para entender o comportamento do modelo.\n\n- **R²**: O valor de \\( R^2 = 0.28 \\) significa que cerca de 28% da variação na taxa de mortalidade infantil (`mort5`) é explicada pela variação no percentual de acesso à água encanada (`t_agua`).\n\n- **Significância**: O p-valor muito pequeno (p < 0.001) indica que o acesso à água encanada tem uma relação estatisticamente significativa com a mortalidade infantil.\n\n\n- **Significância do p-valor**: O p-valor muito baixo (< 0.001) indica que há evidência de que existe uma relação estatisticamente significativa entre o percentual de água encanada e a mortalidade infantil. \n\n\n\n### Visualizando o ajuste do modelo\n\nPara adicionar a linha de regressão ao gráfico anterior, podemos criar uma nova tabela com as predições do modelo linear e os resíduos:\n\n```{r}\npnud_muni_2010_adjusted <- pnud_muni_2010 |>\n  dplyr::mutate(\n    valores_ajustados = predict(modelo_linear), # <1>\n    residuos = mort5 - valores_ajustados # <2>\n  ) \n```\n1. Adiciona uma nova coluna chamada `valores_ajustados` ao data.frame contendo as predições do modelo linear, utilizando a função `predict()`.\n2. Adiciona uma nova coluna chamada `residuos` ao data.frame contendo os resíduos do modelo linear: a diferença entre os valores reais (mort5) e os valores previstos pelo modelo.\n\nAgora, podemos adicionar a linha de regressão ao gráfico anterior:\n\n```{r}\n#| label: lm-simples-reta\npnud_muni_2010_adjusted |> \n  ggplot() + \n  aes(x = t_agua, y = mort5) + \n  geom_point(alpha = 0.5) + \n  geom_line(aes(y = valores_ajustados), color = \"blue\", linewidth = 1) + # <1>\n  theme_light()\n```\n1. Adiciona a linha de regressão com base nas predições do  modelo.\n\n::: {.callout-warning collapse=TRUE}\n### `geom_smooth()`\n\nA função `geom_smooth()` do pacote `{ggplot2}` também pode ser utilizada para adicionar uma linha de regressão ao gráfico. \n\nNo entanto, a função `geom_smooth()` não utiliza as predições do modelo linear que ajustamos, e sim realiza um ajuste (utilizando alguns métodos que podem ser consultados na documentação): \n\n```{r}\n#| label: lm-simples-geom-smooth\npnud_muni_2010 |> \n  ggplot() + \n  aes(x = t_agua, y = mort5) + \n  geom_point(alpha = 0.5) + \n  geom_smooth(method = \"lm\", se = FALSE, color = \"blue\") + \n  theme_light()\n```\n\n:::\n\n\n### Pressupostos da Regressão Linear\n\nAgora que sabemos ajustar um modelo de regressão linear simples, é importante verificar se os pressupostos da regressão linear estão sendo respeitados.\n\n1. **Linearidade**: A relação entre a variável dependente e a(s) variável(is) independente(s) deve ser linear.\n2. **Independência dos Erros**: Os erros devem ser independentes uns dos outros. Não queremos que eles tenham uma ordem ou relação com as variáveis independentes.\n3. **Homoscedasticidade**: A variância dos erros deve ser constante ao longo de todos os níveis da variável independente.\n4. **Normalidade dos Erros**: Os erros devem seguir uma distribuição normal.\n\nPodemos verificar esses pressupostos utilizando gráficos de diagnóstico, que discutiremos em breve.\n\n\n###  Diagnóstico de Modelos\n\nUtilizar gráficos de diagnóstico ajuda a verificar se os pressupostos do modelo estão sendo respeitados. Vamos explorar alguns gráficos de diagnóstico, que são úteis para tomar decisões sobre o modelo!\n\n#### Histograma dos resíduos\n\nPara que os pressupostos sejam satisfeitos, espera-se uma uma distribuição simétrica e aproximadamente normal.\n\nA curva de densidade adicionada ao histograma permite verificar visualmente se os resíduos seguem uma distribuição normal. Se a curva de densidade não se parecer com uma curva gaussiana, isso pode ser um indicativo de que os resíduos não são normalmente distribuídos, violando um dos pressupostos da regressão linear.\n\n\n```{r}\n#| label: lm-simples-histograma-residuos\npnud_muni_2010_adjusted |> # <1>\n  ggplot(aes(x = residuos)) + # <2>\n  geom_histogram( # <3>\n    aes(y = after_stat(density)), # <4>\n    fill = \"lightblue\" # <5>\n  ) +  # <3>\n  geom_density() + # <6>\n  theme_light() # <7>\n```\n1. Utilizando os dados que contém os resíduos do modelo ajustado.\n2. Iniciando o gráfico, e definindo a variável `x` como os resíduos.\n3. Adicionando a geometria de histograma.\n4. Nos atributos estéticos (`aes()`), definimos que o eixo `y` do histograma será a densidade dos resíduos. Quando criamos um histograma, os valores padrão no eixo y correspondem à contagem de observações em cada intervalo (bin). Ao utilizar `after_stat(density)`, estamos instruindo o `ggplot2` a calcular a densidade ao invés da contagem bruta.\n5. Definindo a cor de preenchimento do histograma.\n6. Adicionando a geometria de densidade.\n7. Aplicando o tema `theme_light()` ao gráfico.\n\n\n\n#### Gráfico de resíduos vs valores ajustados\n\nPara que os pressupostos sejam satisfeitos, os pontos devem estar distribuídos aleatoriamente em torno de zero. Se houver um padrão nos resíduos, pode indicar que a relação entre as variáveis não é linear.\n\nA interpretação do gráfico a seguir é de que talvez o modelo linear não seja o mais adequado para ajustar esses dados, pois os resíduos não estão distribuídos aleatoriamente.\n\n```{r}\n#| label: lm-simples-residual-plot\ncar::residualPlot(modelo_linear)\n```\n\n#### Teste de homocedasticidade\n\nPara que os pressupostos sejam satisfeitos, espera-se que a variância dos erros seja constante ao longo de todos os níveis da variável independente. Para verificar isso, podemos utilizar a função `car::ncvTest()`, que testa a homocedasticidade dos resíduos.\n\nUm p-valor muito pequeno (`p < 0.001`) sugere que os resíduos não possuem variância constante (heterocedasticidade), o que pode violar um dos pressupostos da regressão linear.\n\nNeste modelo, o pressuposto de homocedasticidade não é satisfeito.\n\n```{r}\n#| label: lm-simples-homocedasticidade\ncar::ncvTest(modelo_linear)\n```\n\n\n#### Q-Q plot para normalidade dos resíduos\n\nPara que os pressupostos sejam satisfeitos, os pontos devem seguir a linha reta, o que indicaria que os resíduos seguem uma distribuição normal. Desvios significativos da linha indicam que os resíduos não são normais.\n\nNo caso do exemplo a seguir, os resíduos não seguem uma distribuição normal.\n\n```{r}\n#| label: lm-simples-qqplot\ncar::qqPlot(modelo_linear)\n```\n\n\n\n### Extraindo tabelas de regressão\n\nPodemos extrair tabelas de regressão para apresentar os resultados do modelo ajustado.  \nExistem diversos pacotes que podem ser utilizados para extrair tabelas de regressão, como:\n\n- [`{stargazer}`](https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf)\n- [`{gtsummary}`](https://www.danieldsjoberg.com/gtsummary/articles/tbl_regression.html)\n- [`{fixest}`](https://lrberge.github.io/fixest/articles/exporting_tables.html)\n- [`{modelsummary}`](https://modelsummary.com/)\n\n\nVamos utilizar a função `stargazer::stargazer()`. Essa função pode gerar tabelas de regressão em diferentes formatos, como texto, HTML, LaTeX e Markdown.\n\n\n```{r}\nstargazer::stargazer(modelo_linear, type = \"text\")\n```\n\n\nCuidado: observe que na última linha (`Note: *p<0.1; **p<0.05; ***p<0.01`) o resultado em HTML apresenta asteriscos a menos do que o resultado em texto. Isso ocorre porque o Markdown interpreta o asterisco como um comando de itálico (`*`) ou negrito (`**`) (e utilizamos Markdown para a construção deste site). \n\n```{r}\n#| results: asis\nstargazer::stargazer(modelo_linear, type = \"html\")\n```\n\n\n\n\n### Interpretação final\n\n- O modelo que ajustamos pode não ser o mais adequado para explicar a relação entre a taxa de mortalidade infantil e o percentual de acesso à água encanada, pois os pressupostos da regressão linear não foram atendidos. Pode ser necessário ajustar um modelo mais complexo.\n\n- A taxa de mortalidade infantil é influenciada por diversos fatores, e o acesso à água encanada pode ser apenas um deles. É interessante investigar se outras variáveis como renda, educação, saneamento básico, entre outras, são importantes para explicar a mortalidade infantil.\n\n\n\n## Regressão linear múltipla\n\nAté agora, ajustamos um modelo de regressão linear simples. No entanto, é possível ajustar um modelo de regressão linear múltipla, que inclui mais de uma variável independente.\n\n\nNa regressão linear múltipla, incluímos mais de uma variável independente para tentar capturar diferentes fatores que podem influenciar a variável dependente. \n\nQuando ajustamos um modelo de regressão múltipla, estamos tentando entender como a variável dependente (por exemplo, `mort5`) é afetada por várias variáveis independentes (como `t_agua` e `rdpc`).\n\nAdicionar variáveis pode melhorar a precisão do modelo, reduzindo o erro e aumentando o \\(R^2\\), que nos diz quanta variação na variável dependente é explicada pelas variáveis independentes.\n\nVamos ajustar um modelo de regressão linear múltipla para investigar a relação entre a taxa de mortalidade infantil (até 5 anos de idade) (`mort5`) e o percentual da população que vive em domicílios com água encanada (`t_agua`) e a renda per capita (`rdpc`) nos municípios brasileiros em 2010.\n\nEntão, temos que:\n\n- Variável dependente (`y`): `mort5`\n\n- Variáveis independentes (`x`): `t_agua` e `rdpc`\n\n\n### Ajustando o modelo de regressão linear múltipla\n\nPara ajustar um modelo de regressão linear múltipla, basta adicionar as variáveis independentes separadas por `+` na fórmula do modelo.\n\n```{r}\nmodelo_linear_multiplo <- lm(mort5 ~ t_agua + rdpc, data = pnud_muni_2010)\n```\n\nDaqui em diante, o processo é semelhante ao que fizemos para o modelo de regressão linear simples.\n\n#### Explorando o modelo ajustado\n\nPodemos explorar o resultado do modelo ajustado com a função `summary()`:\n\n```{r}\nsummary(modelo_linear_multiplo)\n```\n\n#### Visualizando o ajuste do modelo\n\nA etapa de visualização do ajuste do modelo de regressão linear múltipla é um pouco mais complexa, pois estamos lidando com mais de uma variável independente.\n\nPrecisamos criar um gráfico para cada variável independente, **mantendo as outras variáveis independentes constantes**.\n\nPara isso, primeiro vamos criar uma nova tabela com os valores constantes das variáveis independentes (utilizando a média):\n\n```{r}\npnud_muni_2010_ajustado_agua <- pnud_muni_2010 |> \n  dplyr::mutate(\n    rdpc = mean(rdpc) # <1>\n  )\n\npnud_muni_2010_ajustado_rdpc <- pnud_muni_2010 |>\n  dplyr::mutate(\n    t_agua = mean(t_agua) # <2>\n  )\n```\n1. Criando uma nova tabela (`pnud_muni_2010_ajustado_agua`), onde a variável `rdpc` é constante, utilizando a média dos valores.\n2. Criando uma nova tabela (`pnud_muni_2010_ajustado_rdpc`), onde a variável `t_agua` é constante, utilizando a média dos valores.\n\n\nAgora, vamos criar uma nova tabela com os valores ajustados para cada uma das variáveis independentes constantes (utilizando os dados criados na etapa anterior no argumento `newdata`):\n\n```{r}\npnud_muni_2010_ajustado_multiplo <- pnud_muni_2010 |>\n  dplyr::mutate(\n    valores_ajustados_agua = predict(# <1>\n      modelo_linear_multiplo, \n      newdata = pnud_muni_2010_ajustado_agua\n      ), # <1>\n    \n    valores_ajustados_rdpc = predict(# <2>\n      modelo_linear_multiplo, \n      newdata = pnud_muni_2010_ajustado_rdpc\n      ) # <2>\n  ) \n```\n1. Adicionando uma nova coluna chamada `valores_ajustados_agua` ao data.frame contendo os ajustes do modelo linear múltiplo, utilizando a função `predict()`, e os dados `pnud_muni_2010_ajustado_agua` (onde a variável `rdpc` é constante).\n2. Adicionando uma nova coluna chamada `valores_ajustados_rdpc` ao data.frame contendo os ajustes do modelo linear múltiplo, utilizando a função `predict()`, e os dados `pnud_muni_2010_ajustado_rdpc` (onde a variável `t_agua` é constante).\n\n\nAgora, podemos criar os gráficos para visualizar o ajuste do modelo de regressão linear múltipla.\n\nO gráfico a seguir mostra a relação entre a taxa de mortalidade infantil e o percentual de acesso à água encanada, mantendo as outras variáveis independentes constantes:\n\n```{r}\n#| label: lm-multiplo-agua\npnud_muni_2010_ajustado_multiplo |> \n  ggplot() +\n  geom_point(aes(x = t_agua, y = mort5), alpha = 0.5) + # <1>\n  geom_line(aes(x = t_agua, y = valores_ajustados_agua), color = \"red\") + # <2>\n  theme_light()\n```\n1. Adicionando a geometria de pontos ao gráfico, com os valores de `t_agua` no eixo x e `mort5` no eixo y.\n2. Adicionando a linha de regressão ao gráfico, com os valores ajustados (mantendo as outras variáveis independentes constantes).\n\n\n\nO gráfico a seguir mostra a relação entre a taxa de mortalidade infantil e a renda per capita, mantendo as outras variáveis independentes constantes:\n\n```{r}\n#| label: lm-multiplo-rdpc\npnud_muni_2010_ajustado_multiplo |> \n  ggplot() +\n  geom_point(aes(x = rdpc, y = mort5), alpha = 0.5) + # <1>\n  geom_line(aes(x = rdpc, y = valores_ajustados_rdpc), color = \"red\") + # <2>\n  theme_light() \n```\n1. Adicionando a geometria de pontos ao gráfico, com os valores de `rdpc` no eixo x e `mort5` no eixo y.\n2. Adicionando a linha de regressão ao gráfico, com os valores ajustados (mantendo a `t_agua` constante).\n\n\n\n\n\nO gráfico acima indica que a relação entre `rdpc` e `mort5` não é linear. Nesse caso, podemos tentar transformar a variável `rdpc` e testar novamente ajustar um modelo linear.\n\n\nVamos tentar ajustar um modelo de regressão linear múltipla com a variável `rdpc` transformada em logaritmo (`log()`).\n\n\n### Modelando a variável `rdpc` transformada em `log()`\n\nTransformações em variáveis são usadas quando a relação entre as variáveis independentes e a dependente não é linear. No nosso exemplo, a relação entre `rdpc` e `mort5` não é linear. Ao aplicar a transformação logarítmica à variável `rdpc`, tentamos \"linearizar\" a relação, o que pode melhorar a capacidade do modelo de capturar a verdadeira relação entre as variáveis.\n\n\nVamos ajustar um modelo de regressão linear múltipla com a variável `rdpc` transformada em logaritmo.\n\nPara isso, primeiro vamos criar uma nova variável `rdpc_log` com a transformação logarítmica da variável `rdpc`, e salvar em um novo objeto chamado `pnud_muni_2010_com_log`:\n\n\n```{r}\npnud_muni_2010_com_log <- pnud_muni_2010 |> \n  dplyr::mutate(rdpc_log = log(rdpc)) \n```\n\nAgora, vamos ajustar um modelo de regressão linear múltipla com a variável `rdpc_log`:\n\n```{r}\nmodelo_linear_multiplo_log <- lm(mort5 ~ t_agua + rdpc_log,\n                                 data = pnud_muni_2010_com_log)\n```\n\nVamos explorar o resultado do modelo ajustado:\n\n```{r}\nsummary(modelo_linear_multiplo_log)\n```\n\n#### Visualizando o ajuste do modelo\n\nVamos visualizar o ajuste do modelo (similar ao que fizemos anteriormente). Para isso, vamos criar uma nova tabela com os valores constantes das variáveis independentes (utilizando a média):\n\n```{r}\npnud_muni_2010_ajustado_agua_log <- pnud_muni_2010_com_log |> \n  dplyr::mutate(\n    rdpc_log = mean(rdpc_log), # <1>\n  )\n\npnud_muni_2010_ajustado_rdpc_log  <- pnud_muni_2010_com_log |>\n  dplyr::mutate(\n    t_agua = mean(t_agua) # <2>\n  )\n```\n1. Criando uma nova tabela (`pnud_muni_2010_ajustado_agua`), onde a variável é `rdpc_log` constante, utilizando a média dos valores.\n2. Criando uma nova tabela (`pnud_muni_2010_ajustado_rdpc`), onde a variável é `t_agua` constante, utilizando a média dos valores.\n\nPodemos criar uma nova tabela com os valores ajustados para cada uma das variáveis independentes constantes (utilizando os dados criados na etapa anterior no argumento `newdata`):\n\n```{r}\npnud_muni_2010_ajustado_multiplo_log <- pnud_muni_2010_com_log |>\n  dplyr::mutate(\n    valores_ajustados_agua = predict( # <1>\n      modelo_linear_multiplo_log,\n      newdata = pnud_muni_2010_ajustado_agua_log), # <1>\n    \n    valores_ajustados_rdpc = predict( # <2>\n      modelo_linear_multiplo_log,\n      newdata = pnud_muni_2010_ajustado_rdpc_log), # <2> \n    \n    valores_ajustados = predict(modelo_linear_multiplo_log), # <3>\n    \n    residuos = mort5 - valores_ajustados # <4>\n  ) \n```\n1. Adicionando uma nova coluna chamada `valores_ajustados_agua` ao data.frame contendo os ajustes do modelo linear múltiplo, utilizando a função `predict()`, e os dados `pnud_muni_2010_ajustado_agua_log` (onde a variável `rdpc_log` é constante).\n2. Adicionando uma nova coluna chamada `valores_ajustados_rdpc` ao data.frame contendo os ajustes do modelo linear múltiplo, utilizando a função `predict()`, e os dados `pnud_muni_2010_ajustado_rdpc_log` (onde a variável `t_agua` é constante).\n3. Adicionando uma nova coluna chamada `valores_ajustados` ao data.frame contendo os ajustes do modelo linear múltiplo.\n4. Adicionando uma nova coluna chamada `residuos` ao data.frame contendo os resíduos do modelo linear: a diferença entre os valores reais (mort5) e os valores previstos pelo modelo.\n\n\nAgora, vamos visualizar o ajuste do modelo de regressão linear múltipla com a variável `rdpc` transformada em logaritmo.\n\n\n```{r}\n#| label: lm-multiplo-log-agua\npnud_muni_2010_ajustado_multiplo_log |> \n  ggplot() +\n  geom_point(aes(x = t_agua, y = mort5), alpha = 0.5) +\n  geom_line(aes(x = t_agua, y = valores_ajustados_agua), color = \"red\") +\n  theme_light() \n```\n\n\n```{r}\n#| label: lm-multiplo-log-rdpc\npnud_muni_2010_ajustado_multiplo_log |> \n  ggplot() +\n  geom_point(aes(x = rdpc_log, y = mort5), alpha = 0.5) +\n  geom_line(aes(x = rdpc_log, y = valores_ajustados_rdpc), color = \"red\") +\n  theme_light() \n```\n\nO segundo gráfico indica que o resultado do modelo ajustado com a variável `rdpc` transformada em logaritmo é melhor do que o modelo anterior. Vamos seguir com a análise do modelo ajustado.\n\n#### Explorando o modelo ajustado\n\nPodemos explorar o resultado do modelo ajustado com a função `summary()`, `broom::tidy()` e `report::report()`:\n\n```{r}\nreport::report(modelo_linear_multiplo_log) \n```\n\n```{r}\nbroom::tidy(modelo_linear_multiplo_log) |> \n  knitr::kable()\n```\n\n\n#### Diagnóstico do Modelo de Regressão Múltipla\n\nOs diagnósticos do modelo de regressão múltipla são similares aos da regressão simples, mas é importante prestar mais atenção nos resíduos, pois agora temos mais de uma variável explicativa. \n\nOs mesmos pressupostos de linearidade, independência dos erros, homocedasticidade e normalidade dos resíduos precisam ser verificados.\n\n\n##### Histograma dos resíduos\n\n```{r}\n#| label: lm-multiplo-log-histograma-residuos\npnud_muni_2010_ajustado_multiplo_log |>\n  ggplot(aes(x = residuos)) +\n  geom_histogram(\n    aes(y = after_stat(density)),\n    fill = \"lightblue\"\n  ) +\n  geom_density() +\n  theme_light()\n```\n\n##### Gráfico de resíduos vs valores ajustados\n\nÉ importante verificar se os resíduos estão distribuídos de forma aleatória. Se houver padrões, o modelo pode estar mal especificado.\n\n```{r}\n#| label: lm-multiplo-log-residual-plot\ncar::residualPlot(modelo_linear_multiplo_log)\n```\n\n##### Teste de homocedasticidade\n\nÉ importante verificar se a variância dos resíduos é constante ao longo dos valores ajustados.\n\n```{r}\n#| label: lm-multiplo-log-homocedasticidade\ncar::ncvTest(modelo_linear_multiplo_log)\n```\n\n##### Q-Q plot para normalidade dos resíduos\n\nÉ importante verificar a normalidade dos resíduos.\n\n```{r}\n#| label: lm-multiplo-log-qqplot\ncar::qqPlot(modelo_linear_multiplo_log)\n```\n\n#### Extraindo tabelas de regressão\n\n\n```{r}\nstargazer::stargazer(modelo_linear_multiplo_log, type = \"text\")\n```\n\n\n\n## Sugestões de exercícios\n\n1. Utilize os dados de 2010 do PNUD que já carregamos (`pnud_muni_2010`). Ajuste um modelo de regressão linear simples para investigar a relação entre a taxa de mortalidade infantil (até 5 anos de idade) (`mort5`) e a renda per capita (`rdpc`), disponível nos dados.\n\na. Identifique qual é a variável dependente e qual é a variável independente.\n\nb. Visualize a relação entre essas duas variáveis utilizando um gráfico de dispersão. Antes de ajustar o modelo, o que você espera encontrar? Parece haver uma relação linear entre as variáveis?\n\nc. Ajuste um modelo de regressão linear simples.\n\nc. Interprete o coeficiente da variável `rdpc`.\n\nd. Após ajustar o modelo no exercício anterior, avalie se os pressupostos da regressão linear foram atendidos.\n\ne. Verifique o valor de \\(R^2\\) e interprete seu significado. \n\nf. O p-valor do coeficiente de `rdpc` é significativo? O que isso indica sobre a relação entre essas variáveis?\n\ng. Crie um gráfico de dispersão entre as variáveis, adicionando uma linha de regressão ao gráfico.\n\nh. Esse modelo é melhor para explicar a expectativa de vida do que o modelo anterior que ajustamos para a taxa de mortalidade infantil? Por quê?\n\n## Links citados na aula\n\n- [Pacote performance](https://easystats.github.io/performance/articles/check_model.html): funções para avaliar o ajuste de modelos de regressão, visualizar diagnósticos e comparar modelos.\n\n- [Pacote modelsummary](https://modelsummary.com/): para criar tabelas de regressão, que exportam para word.\n\n- [Pacote coefplot](https://cran.r-project.org/web/packages/coefplot/index.html): para visualizar os coeficientes do modelo de regressão linear.\n\n- [Tidymodels](https://www.tidymodels.org/packages/) - metapacote, segue uma filosofia similar ao pacote tidyverse, para quem tem interesse em *machine learning* no R.\n\n- [Livro R Packages](https://r-pkgs.org/) - para quem tem interesse em criar pacotes no R.\n\n- Livro \"Uma senhora toma chá...: Como a estatística revolucionou a ciência no século XX\" - David Salsburg\n\n\n## Sugestões de materiais\n\n- [Livro *Introduction to Modern Statistics*](https://openintro-ims.netlify.app) de Mine Çetinkaya-Rundel e Johanna Hardin. \n  - [Regressão linear simples](https://openintro-ims.netlify.app/model-slr)\n  - [Regressão linear múltipla](https://openintro-ims.netlify.app/model-mlr)\n  \n  \n- [Introduction to Econometrics with R](https://www.econometrics-with-r.org/) - conteúdo mais avançado, para quem tem experiência em econometria.","srcMarkdownNoYaml":"\n\n\n\n## Introdução\n\nA regressão linear é uma técnica estatística que busca modelar a relação entre uma variável dependente e uma ou mais variáveis independentes. A regressão linear simples é utilizada quando temos apenas uma variável independente, enquanto a regressão linear múltipla é utilizada quando temos mais de uma variável independente.\n\nNesta aula, exploraremos:\n\n  - Como ajustar um modelo de regressão linear simples e múltipla no R.\n  \n  - Como extrair informações sobre o modelo ajustado.\n  \n  - Como visualizar o ajuste do modelo.\n  \n  - Como verificar os pressupostos da regressão linear.\n  \n  - Como extrair tabelas de regressão para apresentação dos resultados.\n  \n::: callout-warning\n\nO objetivo desta aula **não** é aprofundar nos conceitos teóricos da regressão linear, mas sim apresentar como ajustar e explorar funções que permitem ajustar modelos de regressão linear no R. Caso você tenha dúvidas sobre os conceitos teóricos, consulte os [materiais sugeridos no final desta aula](#sugest%C3%B5es-de-materiais).\n:::\n\n## Instalando pacotes\n\nPara esta aula, utilizaremos alguns pacotes do R, que talvez não tenham sido instalados anteriormente:\n\n```{r}\n#| eval: false\npacotes <- c(\"abjData\", \"broom\", \"car\", \"stargazer\", \"report\")\ninstall.packages(pacotes)\n```\n\n\n## Carregando pacotes\n\nVamos carregar o pacote `{ggplot2}`, que utilizamos anteriormente para elaborar gráficos:\n\n```{r}\n#| message: false\nlibrary(ggplot2)\n```\n\nO comando abaixo desabilita a notação científica no R, o que facilita a leitura dos resultados:\n\n```{r}\noptions(scipen = 999) \n```\n\n## Importando os dados\n\nNesta aula, utilizaremos os dados do [Programa das Nações Unidas para o Desenvolvimento (PNUD)](http://www.br.undp.org/content/brazil/pt/home/idh0/rankings/idhm-municipios-2010.html) sobre o Índice de Desenvolvimento Humano Municipal (IDHM) e suas dimensões para os municípios brasileiros em 2010. Esses dados estão disponíveis no pacote `abjData`.\n\nVamos filtrar os dados mais recentes disponíveis (censo de 2010) e salvar em um objeto chamado `pnud_muni_2010`:\n\n```{r}\npnud_muni_2010 <- abjData::pnud_muni |> \n dplyr::filter(ano == 2010) \n```\n\n**Obs:** O pacote `abjData` contém dados do PNUD para os anos de 1991, 2000 e 2010. Utilizamos apenas os dados de 2010 nesta aula, pois os dados não são independentes entre si. Se quisermos ajustar um modelo com dados de diferentes anos, seria necessário ajustar um modelo longitudinal (em painel), o que foge do escopo desta aula.\n\n### Dicionário dos dados\n\nA tabela `pnud_muni_2010` contém muitas variáveis, e alguns nomes não são muito descritivos. Podemos consultar o significado de cada variável consultando a tabela `pnud_siglas` do pacote `{abjData}`:\n\n```{r}\nnomes_col_pnud_muni_2010 <- abjData::pnud_siglas |> \n  dplyr::filter(sigla %in% names(pnud_muni_2010))\n\nnomes_col_pnud_muni_2010 |> \n  DT::datatable()\n```\n\n## Pergunta a ser explorada\n\nQueremos explorar a seguinte pergunta: **Dentre as variáveis a seguir, qual explica mais a mortalidade infantil?**\n  - `t_agua`: Percentual da população que vive em domicílios com água encanada.\n  - `rdpc`: Renda per capita.\n\n```{r}\nnomes_col_pnud_muni_2010 |> \n  dplyr::filter(sigla %in% c(\"mort5\", \"t_agua\", \"rdpc\")) |> \n  knitr::kable()\n```\n\n\n## Regressão linear simples\n\nExistem várias maneiras de ajustar um modelo de regressão linear no R: podemos usar funções do R base, ou funções de outros pacotes, como o `{fixest}`.\n\nVamos ajustar um modelo de regressão linear simples utilizando a função  função `lm()`, do R base.\n\nUma primeira variável que podemos explorar é o acesso à água encanada.\n\nVamos ajustar um modelo de regressão linear simples para investigar a relação entre a taxa de mortalidade infantil (até 5 anos de idade) (`mort5`) e o percentual da população que vive em domicílios com água encanada (`t_agua`) nos municípios brasileiros em 2010.\n\nEntão, temos que:\n\n- Variável dependente (`y`): `mort5`\n\n- Variável independente (`x`): `t_agua`\n\n### Visualizando a relação entre as variáveis\n\nPrimeiramente, podemos visualizar a relação entre as variáveis. Caso você não lembre como fazer isso, consulte a [aula sobre visualização de dados](07_visualizacao.qmd).\n\n```{r}\n#| label: lm-simples-relacao-variaveis\npnud_muni_2010 |> # <1>\n  ggplot() + # <2>\n  aes(x = t_agua, y = mort5) + # <3>\n  geom_point(alpha = 0.5) + # <4>\n  theme_light()\n```\n1. Utilizamos os dados do objeto `pnud_muni_2010`.\n2. Iniciamos um gráfico.\n3. Definimos as variáveis `x` e `y`.\n4. Adicionamos a geometria de pontos ao gráfico. O argumento `alpha = 0.5` define a transparência dos pontos em 50%.\n\n\n\n### Ajustando o modelo\n\nUma maneira é usar a função `lm()`, de *linear model* (modelo linear), para ajustar o modelo de regressão linear simples. Essa função recebe como argumentos a fórmula do modelo (`y ~ x`, lê-se `y` em função de `x`) e os dados (argumento `data`).\n\n\n```{r}\nmodelo_linear <- lm(mort5 ~ t_agua, data = pnud_muni_2010)\n```\n\n### Explorando o modelo ajustado\n\nPodemos explorar o resultado do modelo ajustado de várias formas!\n\nA função `summary()` nos fornece um resumo do modelo ajustado:\n\n```{r}\nsummary(modelo_linear)\n```\n\nPodemos extrair uma *tibble* com informações sobre o modelo ajustado utilizando as funções `tidy()` e `glance()` do pacote `{broom}`. A função `broom::tidy()` nos fornece informações sobre os coeficientes do modelo ajustado.\n\n```{r}\nbroom::tidy(modelo_linear) |> \n  knitr::kable()\n```\nOs resultados da função `broom::glance()` são relativos ao ajuste do modelo, sendo útil para comparar diferentes modelos.\n\n```{r}\nbroom::glance(modelo_linear)|> \n  knitr::kable()\n```\n\n\nA função `report::report()` nos fornece um relatório completo sobre o modelo ajustado:\n\n```{r}\nreport::report(modelo_linear) \n```\n\n\n\n### Interpretação dos resultados\n\nA equação ajustada é:\n\n\n$$\nmort5 = 44.23 - 0.27 \\times tagua\n$$\n- **Interpretação do Coeficiente de `t_agua`**: Para cada aumento de 1% no percentual de água encanada, espera-se uma redução de 0.27 na taxa de mortalidade infantil (por 1000 nascidos vivos).\n\n- **Interpretação do Intercepto**: Se o percentual de água encanada fosse 0, a mortalidade infantil seria de 44.23 por 1000 nascidos vivos. Este valor pode não ser relevante na prática, mas é útil para entender o comportamento do modelo.\n\n- **R²**: O valor de \\( R^2 = 0.28 \\) significa que cerca de 28% da variação na taxa de mortalidade infantil (`mort5`) é explicada pela variação no percentual de acesso à água encanada (`t_agua`).\n\n- **Significância**: O p-valor muito pequeno (p < 0.001) indica que o acesso à água encanada tem uma relação estatisticamente significativa com a mortalidade infantil.\n\n\n- **Significância do p-valor**: O p-valor muito baixo (< 0.001) indica que há evidência de que existe uma relação estatisticamente significativa entre o percentual de água encanada e a mortalidade infantil. \n\n\n\n### Visualizando o ajuste do modelo\n\nPara adicionar a linha de regressão ao gráfico anterior, podemos criar uma nova tabela com as predições do modelo linear e os resíduos:\n\n```{r}\npnud_muni_2010_adjusted <- pnud_muni_2010 |>\n  dplyr::mutate(\n    valores_ajustados = predict(modelo_linear), # <1>\n    residuos = mort5 - valores_ajustados # <2>\n  ) \n```\n1. Adiciona uma nova coluna chamada `valores_ajustados` ao data.frame contendo as predições do modelo linear, utilizando a função `predict()`.\n2. Adiciona uma nova coluna chamada `residuos` ao data.frame contendo os resíduos do modelo linear: a diferença entre os valores reais (mort5) e os valores previstos pelo modelo.\n\nAgora, podemos adicionar a linha de regressão ao gráfico anterior:\n\n```{r}\n#| label: lm-simples-reta\npnud_muni_2010_adjusted |> \n  ggplot() + \n  aes(x = t_agua, y = mort5) + \n  geom_point(alpha = 0.5) + \n  geom_line(aes(y = valores_ajustados), color = \"blue\", linewidth = 1) + # <1>\n  theme_light()\n```\n1. Adiciona a linha de regressão com base nas predições do  modelo.\n\n::: {.callout-warning collapse=TRUE}\n### `geom_smooth()`\n\nA função `geom_smooth()` do pacote `{ggplot2}` também pode ser utilizada para adicionar uma linha de regressão ao gráfico. \n\nNo entanto, a função `geom_smooth()` não utiliza as predições do modelo linear que ajustamos, e sim realiza um ajuste (utilizando alguns métodos que podem ser consultados na documentação): \n\n```{r}\n#| label: lm-simples-geom-smooth\npnud_muni_2010 |> \n  ggplot() + \n  aes(x = t_agua, y = mort5) + \n  geom_point(alpha = 0.5) + \n  geom_smooth(method = \"lm\", se = FALSE, color = \"blue\") + \n  theme_light()\n```\n\n:::\n\n\n### Pressupostos da Regressão Linear\n\nAgora que sabemos ajustar um modelo de regressão linear simples, é importante verificar se os pressupostos da regressão linear estão sendo respeitados.\n\n1. **Linearidade**: A relação entre a variável dependente e a(s) variável(is) independente(s) deve ser linear.\n2. **Independência dos Erros**: Os erros devem ser independentes uns dos outros. Não queremos que eles tenham uma ordem ou relação com as variáveis independentes.\n3. **Homoscedasticidade**: A variância dos erros deve ser constante ao longo de todos os níveis da variável independente.\n4. **Normalidade dos Erros**: Os erros devem seguir uma distribuição normal.\n\nPodemos verificar esses pressupostos utilizando gráficos de diagnóstico, que discutiremos em breve.\n\n\n###  Diagnóstico de Modelos\n\nUtilizar gráficos de diagnóstico ajuda a verificar se os pressupostos do modelo estão sendo respeitados. Vamos explorar alguns gráficos de diagnóstico, que são úteis para tomar decisões sobre o modelo!\n\n#### Histograma dos resíduos\n\nPara que os pressupostos sejam satisfeitos, espera-se uma uma distribuição simétrica e aproximadamente normal.\n\nA curva de densidade adicionada ao histograma permite verificar visualmente se os resíduos seguem uma distribuição normal. Se a curva de densidade não se parecer com uma curva gaussiana, isso pode ser um indicativo de que os resíduos não são normalmente distribuídos, violando um dos pressupostos da regressão linear.\n\n\n```{r}\n#| label: lm-simples-histograma-residuos\npnud_muni_2010_adjusted |> # <1>\n  ggplot(aes(x = residuos)) + # <2>\n  geom_histogram( # <3>\n    aes(y = after_stat(density)), # <4>\n    fill = \"lightblue\" # <5>\n  ) +  # <3>\n  geom_density() + # <6>\n  theme_light() # <7>\n```\n1. Utilizando os dados que contém os resíduos do modelo ajustado.\n2. Iniciando o gráfico, e definindo a variável `x` como os resíduos.\n3. Adicionando a geometria de histograma.\n4. Nos atributos estéticos (`aes()`), definimos que o eixo `y` do histograma será a densidade dos resíduos. Quando criamos um histograma, os valores padrão no eixo y correspondem à contagem de observações em cada intervalo (bin). Ao utilizar `after_stat(density)`, estamos instruindo o `ggplot2` a calcular a densidade ao invés da contagem bruta.\n5. Definindo a cor de preenchimento do histograma.\n6. Adicionando a geometria de densidade.\n7. Aplicando o tema `theme_light()` ao gráfico.\n\n\n\n#### Gráfico de resíduos vs valores ajustados\n\nPara que os pressupostos sejam satisfeitos, os pontos devem estar distribuídos aleatoriamente em torno de zero. Se houver um padrão nos resíduos, pode indicar que a relação entre as variáveis não é linear.\n\nA interpretação do gráfico a seguir é de que talvez o modelo linear não seja o mais adequado para ajustar esses dados, pois os resíduos não estão distribuídos aleatoriamente.\n\n```{r}\n#| label: lm-simples-residual-plot\ncar::residualPlot(modelo_linear)\n```\n\n#### Teste de homocedasticidade\n\nPara que os pressupostos sejam satisfeitos, espera-se que a variância dos erros seja constante ao longo de todos os níveis da variável independente. Para verificar isso, podemos utilizar a função `car::ncvTest()`, que testa a homocedasticidade dos resíduos.\n\nUm p-valor muito pequeno (`p < 0.001`) sugere que os resíduos não possuem variância constante (heterocedasticidade), o que pode violar um dos pressupostos da regressão linear.\n\nNeste modelo, o pressuposto de homocedasticidade não é satisfeito.\n\n```{r}\n#| label: lm-simples-homocedasticidade\ncar::ncvTest(modelo_linear)\n```\n\n\n#### Q-Q plot para normalidade dos resíduos\n\nPara que os pressupostos sejam satisfeitos, os pontos devem seguir a linha reta, o que indicaria que os resíduos seguem uma distribuição normal. Desvios significativos da linha indicam que os resíduos não são normais.\n\nNo caso do exemplo a seguir, os resíduos não seguem uma distribuição normal.\n\n```{r}\n#| label: lm-simples-qqplot\ncar::qqPlot(modelo_linear)\n```\n\n\n\n### Extraindo tabelas de regressão\n\nPodemos extrair tabelas de regressão para apresentar os resultados do modelo ajustado.  \nExistem diversos pacotes que podem ser utilizados para extrair tabelas de regressão, como:\n\n- [`{stargazer}`](https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf)\n- [`{gtsummary}`](https://www.danieldsjoberg.com/gtsummary/articles/tbl_regression.html)\n- [`{fixest}`](https://lrberge.github.io/fixest/articles/exporting_tables.html)\n- [`{modelsummary}`](https://modelsummary.com/)\n\n\nVamos utilizar a função `stargazer::stargazer()`. Essa função pode gerar tabelas de regressão em diferentes formatos, como texto, HTML, LaTeX e Markdown.\n\n\n```{r}\nstargazer::stargazer(modelo_linear, type = \"text\")\n```\n\n\nCuidado: observe que na última linha (`Note: *p<0.1; **p<0.05; ***p<0.01`) o resultado em HTML apresenta asteriscos a menos do que o resultado em texto. Isso ocorre porque o Markdown interpreta o asterisco como um comando de itálico (`*`) ou negrito (`**`) (e utilizamos Markdown para a construção deste site). \n\n```{r}\n#| results: asis\nstargazer::stargazer(modelo_linear, type = \"html\")\n```\n\n\n\n\n### Interpretação final\n\n- O modelo que ajustamos pode não ser o mais adequado para explicar a relação entre a taxa de mortalidade infantil e o percentual de acesso à água encanada, pois os pressupostos da regressão linear não foram atendidos. Pode ser necessário ajustar um modelo mais complexo.\n\n- A taxa de mortalidade infantil é influenciada por diversos fatores, e o acesso à água encanada pode ser apenas um deles. É interessante investigar se outras variáveis como renda, educação, saneamento básico, entre outras, são importantes para explicar a mortalidade infantil.\n\n\n\n## Regressão linear múltipla\n\nAté agora, ajustamos um modelo de regressão linear simples. No entanto, é possível ajustar um modelo de regressão linear múltipla, que inclui mais de uma variável independente.\n\n\nNa regressão linear múltipla, incluímos mais de uma variável independente para tentar capturar diferentes fatores que podem influenciar a variável dependente. \n\nQuando ajustamos um modelo de regressão múltipla, estamos tentando entender como a variável dependente (por exemplo, `mort5`) é afetada por várias variáveis independentes (como `t_agua` e `rdpc`).\n\nAdicionar variáveis pode melhorar a precisão do modelo, reduzindo o erro e aumentando o \\(R^2\\), que nos diz quanta variação na variável dependente é explicada pelas variáveis independentes.\n\nVamos ajustar um modelo de regressão linear múltipla para investigar a relação entre a taxa de mortalidade infantil (até 5 anos de idade) (`mort5`) e o percentual da população que vive em domicílios com água encanada (`t_agua`) e a renda per capita (`rdpc`) nos municípios brasileiros em 2010.\n\nEntão, temos que:\n\n- Variável dependente (`y`): `mort5`\n\n- Variáveis independentes (`x`): `t_agua` e `rdpc`\n\n\n### Ajustando o modelo de regressão linear múltipla\n\nPara ajustar um modelo de regressão linear múltipla, basta adicionar as variáveis independentes separadas por `+` na fórmula do modelo.\n\n```{r}\nmodelo_linear_multiplo <- lm(mort5 ~ t_agua + rdpc, data = pnud_muni_2010)\n```\n\nDaqui em diante, o processo é semelhante ao que fizemos para o modelo de regressão linear simples.\n\n#### Explorando o modelo ajustado\n\nPodemos explorar o resultado do modelo ajustado com a função `summary()`:\n\n```{r}\nsummary(modelo_linear_multiplo)\n```\n\n#### Visualizando o ajuste do modelo\n\nA etapa de visualização do ajuste do modelo de regressão linear múltipla é um pouco mais complexa, pois estamos lidando com mais de uma variável independente.\n\nPrecisamos criar um gráfico para cada variável independente, **mantendo as outras variáveis independentes constantes**.\n\nPara isso, primeiro vamos criar uma nova tabela com os valores constantes das variáveis independentes (utilizando a média):\n\n```{r}\npnud_muni_2010_ajustado_agua <- pnud_muni_2010 |> \n  dplyr::mutate(\n    rdpc = mean(rdpc) # <1>\n  )\n\npnud_muni_2010_ajustado_rdpc <- pnud_muni_2010 |>\n  dplyr::mutate(\n    t_agua = mean(t_agua) # <2>\n  )\n```\n1. Criando uma nova tabela (`pnud_muni_2010_ajustado_agua`), onde a variável `rdpc` é constante, utilizando a média dos valores.\n2. Criando uma nova tabela (`pnud_muni_2010_ajustado_rdpc`), onde a variável `t_agua` é constante, utilizando a média dos valores.\n\n\nAgora, vamos criar uma nova tabela com os valores ajustados para cada uma das variáveis independentes constantes (utilizando os dados criados na etapa anterior no argumento `newdata`):\n\n```{r}\npnud_muni_2010_ajustado_multiplo <- pnud_muni_2010 |>\n  dplyr::mutate(\n    valores_ajustados_agua = predict(# <1>\n      modelo_linear_multiplo, \n      newdata = pnud_muni_2010_ajustado_agua\n      ), # <1>\n    \n    valores_ajustados_rdpc = predict(# <2>\n      modelo_linear_multiplo, \n      newdata = pnud_muni_2010_ajustado_rdpc\n      ) # <2>\n  ) \n```\n1. Adicionando uma nova coluna chamada `valores_ajustados_agua` ao data.frame contendo os ajustes do modelo linear múltiplo, utilizando a função `predict()`, e os dados `pnud_muni_2010_ajustado_agua` (onde a variável `rdpc` é constante).\n2. Adicionando uma nova coluna chamada `valores_ajustados_rdpc` ao data.frame contendo os ajustes do modelo linear múltiplo, utilizando a função `predict()`, e os dados `pnud_muni_2010_ajustado_rdpc` (onde a variável `t_agua` é constante).\n\n\nAgora, podemos criar os gráficos para visualizar o ajuste do modelo de regressão linear múltipla.\n\nO gráfico a seguir mostra a relação entre a taxa de mortalidade infantil e o percentual de acesso à água encanada, mantendo as outras variáveis independentes constantes:\n\n```{r}\n#| label: lm-multiplo-agua\npnud_muni_2010_ajustado_multiplo |> \n  ggplot() +\n  geom_point(aes(x = t_agua, y = mort5), alpha = 0.5) + # <1>\n  geom_line(aes(x = t_agua, y = valores_ajustados_agua), color = \"red\") + # <2>\n  theme_light()\n```\n1. Adicionando a geometria de pontos ao gráfico, com os valores de `t_agua` no eixo x e `mort5` no eixo y.\n2. Adicionando a linha de regressão ao gráfico, com os valores ajustados (mantendo as outras variáveis independentes constantes).\n\n\n\nO gráfico a seguir mostra a relação entre a taxa de mortalidade infantil e a renda per capita, mantendo as outras variáveis independentes constantes:\n\n```{r}\n#| label: lm-multiplo-rdpc\npnud_muni_2010_ajustado_multiplo |> \n  ggplot() +\n  geom_point(aes(x = rdpc, y = mort5), alpha = 0.5) + # <1>\n  geom_line(aes(x = rdpc, y = valores_ajustados_rdpc), color = \"red\") + # <2>\n  theme_light() \n```\n1. Adicionando a geometria de pontos ao gráfico, com os valores de `rdpc` no eixo x e `mort5` no eixo y.\n2. Adicionando a linha de regressão ao gráfico, com os valores ajustados (mantendo a `t_agua` constante).\n\n\n\n\n\nO gráfico acima indica que a relação entre `rdpc` e `mort5` não é linear. Nesse caso, podemos tentar transformar a variável `rdpc` e testar novamente ajustar um modelo linear.\n\n\nVamos tentar ajustar um modelo de regressão linear múltipla com a variável `rdpc` transformada em logaritmo (`log()`).\n\n\n### Modelando a variável `rdpc` transformada em `log()`\n\nTransformações em variáveis são usadas quando a relação entre as variáveis independentes e a dependente não é linear. No nosso exemplo, a relação entre `rdpc` e `mort5` não é linear. Ao aplicar a transformação logarítmica à variável `rdpc`, tentamos \"linearizar\" a relação, o que pode melhorar a capacidade do modelo de capturar a verdadeira relação entre as variáveis.\n\n\nVamos ajustar um modelo de regressão linear múltipla com a variável `rdpc` transformada em logaritmo.\n\nPara isso, primeiro vamos criar uma nova variável `rdpc_log` com a transformação logarítmica da variável `rdpc`, e salvar em um novo objeto chamado `pnud_muni_2010_com_log`:\n\n\n```{r}\npnud_muni_2010_com_log <- pnud_muni_2010 |> \n  dplyr::mutate(rdpc_log = log(rdpc)) \n```\n\nAgora, vamos ajustar um modelo de regressão linear múltipla com a variável `rdpc_log`:\n\n```{r}\nmodelo_linear_multiplo_log <- lm(mort5 ~ t_agua + rdpc_log,\n                                 data = pnud_muni_2010_com_log)\n```\n\nVamos explorar o resultado do modelo ajustado:\n\n```{r}\nsummary(modelo_linear_multiplo_log)\n```\n\n#### Visualizando o ajuste do modelo\n\nVamos visualizar o ajuste do modelo (similar ao que fizemos anteriormente). Para isso, vamos criar uma nova tabela com os valores constantes das variáveis independentes (utilizando a média):\n\n```{r}\npnud_muni_2010_ajustado_agua_log <- pnud_muni_2010_com_log |> \n  dplyr::mutate(\n    rdpc_log = mean(rdpc_log), # <1>\n  )\n\npnud_muni_2010_ajustado_rdpc_log  <- pnud_muni_2010_com_log |>\n  dplyr::mutate(\n    t_agua = mean(t_agua) # <2>\n  )\n```\n1. Criando uma nova tabela (`pnud_muni_2010_ajustado_agua`), onde a variável é `rdpc_log` constante, utilizando a média dos valores.\n2. Criando uma nova tabela (`pnud_muni_2010_ajustado_rdpc`), onde a variável é `t_agua` constante, utilizando a média dos valores.\n\nPodemos criar uma nova tabela com os valores ajustados para cada uma das variáveis independentes constantes (utilizando os dados criados na etapa anterior no argumento `newdata`):\n\n```{r}\npnud_muni_2010_ajustado_multiplo_log <- pnud_muni_2010_com_log |>\n  dplyr::mutate(\n    valores_ajustados_agua = predict( # <1>\n      modelo_linear_multiplo_log,\n      newdata = pnud_muni_2010_ajustado_agua_log), # <1>\n    \n    valores_ajustados_rdpc = predict( # <2>\n      modelo_linear_multiplo_log,\n      newdata = pnud_muni_2010_ajustado_rdpc_log), # <2> \n    \n    valores_ajustados = predict(modelo_linear_multiplo_log), # <3>\n    \n    residuos = mort5 - valores_ajustados # <4>\n  ) \n```\n1. Adicionando uma nova coluna chamada `valores_ajustados_agua` ao data.frame contendo os ajustes do modelo linear múltiplo, utilizando a função `predict()`, e os dados `pnud_muni_2010_ajustado_agua_log` (onde a variável `rdpc_log` é constante).\n2. Adicionando uma nova coluna chamada `valores_ajustados_rdpc` ao data.frame contendo os ajustes do modelo linear múltiplo, utilizando a função `predict()`, e os dados `pnud_muni_2010_ajustado_rdpc_log` (onde a variável `t_agua` é constante).\n3. Adicionando uma nova coluna chamada `valores_ajustados` ao data.frame contendo os ajustes do modelo linear múltiplo.\n4. Adicionando uma nova coluna chamada `residuos` ao data.frame contendo os resíduos do modelo linear: a diferença entre os valores reais (mort5) e os valores previstos pelo modelo.\n\n\nAgora, vamos visualizar o ajuste do modelo de regressão linear múltipla com a variável `rdpc` transformada em logaritmo.\n\n\n```{r}\n#| label: lm-multiplo-log-agua\npnud_muni_2010_ajustado_multiplo_log |> \n  ggplot() +\n  geom_point(aes(x = t_agua, y = mort5), alpha = 0.5) +\n  geom_line(aes(x = t_agua, y = valores_ajustados_agua), color = \"red\") +\n  theme_light() \n```\n\n\n```{r}\n#| label: lm-multiplo-log-rdpc\npnud_muni_2010_ajustado_multiplo_log |> \n  ggplot() +\n  geom_point(aes(x = rdpc_log, y = mort5), alpha = 0.5) +\n  geom_line(aes(x = rdpc_log, y = valores_ajustados_rdpc), color = \"red\") +\n  theme_light() \n```\n\nO segundo gráfico indica que o resultado do modelo ajustado com a variável `rdpc` transformada em logaritmo é melhor do que o modelo anterior. Vamos seguir com a análise do modelo ajustado.\n\n#### Explorando o modelo ajustado\n\nPodemos explorar o resultado do modelo ajustado com a função `summary()`, `broom::tidy()` e `report::report()`:\n\n```{r}\nreport::report(modelo_linear_multiplo_log) \n```\n\n```{r}\nbroom::tidy(modelo_linear_multiplo_log) |> \n  knitr::kable()\n```\n\n\n#### Diagnóstico do Modelo de Regressão Múltipla\n\nOs diagnósticos do modelo de regressão múltipla são similares aos da regressão simples, mas é importante prestar mais atenção nos resíduos, pois agora temos mais de uma variável explicativa. \n\nOs mesmos pressupostos de linearidade, independência dos erros, homocedasticidade e normalidade dos resíduos precisam ser verificados.\n\n\n##### Histograma dos resíduos\n\n```{r}\n#| label: lm-multiplo-log-histograma-residuos\npnud_muni_2010_ajustado_multiplo_log |>\n  ggplot(aes(x = residuos)) +\n  geom_histogram(\n    aes(y = after_stat(density)),\n    fill = \"lightblue\"\n  ) +\n  geom_density() +\n  theme_light()\n```\n\n##### Gráfico de resíduos vs valores ajustados\n\nÉ importante verificar se os resíduos estão distribuídos de forma aleatória. Se houver padrões, o modelo pode estar mal especificado.\n\n```{r}\n#| label: lm-multiplo-log-residual-plot\ncar::residualPlot(modelo_linear_multiplo_log)\n```\n\n##### Teste de homocedasticidade\n\nÉ importante verificar se a variância dos resíduos é constante ao longo dos valores ajustados.\n\n```{r}\n#| label: lm-multiplo-log-homocedasticidade\ncar::ncvTest(modelo_linear_multiplo_log)\n```\n\n##### Q-Q plot para normalidade dos resíduos\n\nÉ importante verificar a normalidade dos resíduos.\n\n```{r}\n#| label: lm-multiplo-log-qqplot\ncar::qqPlot(modelo_linear_multiplo_log)\n```\n\n#### Extraindo tabelas de regressão\n\n\n```{r}\nstargazer::stargazer(modelo_linear_multiplo_log, type = \"text\")\n```\n\n\n\n## Sugestões de exercícios\n\n1. Utilize os dados de 2010 do PNUD que já carregamos (`pnud_muni_2010`). Ajuste um modelo de regressão linear simples para investigar a relação entre a taxa de mortalidade infantil (até 5 anos de idade) (`mort5`) e a renda per capita (`rdpc`), disponível nos dados.\n\na. Identifique qual é a variável dependente e qual é a variável independente.\n\nb. Visualize a relação entre essas duas variáveis utilizando um gráfico de dispersão. Antes de ajustar o modelo, o que você espera encontrar? Parece haver uma relação linear entre as variáveis?\n\nc. Ajuste um modelo de regressão linear simples.\n\nc. Interprete o coeficiente da variável `rdpc`.\n\nd. Após ajustar o modelo no exercício anterior, avalie se os pressupostos da regressão linear foram atendidos.\n\ne. Verifique o valor de \\(R^2\\) e interprete seu significado. \n\nf. O p-valor do coeficiente de `rdpc` é significativo? O que isso indica sobre a relação entre essas variáveis?\n\ng. Crie um gráfico de dispersão entre as variáveis, adicionando uma linha de regressão ao gráfico.\n\nh. Esse modelo é melhor para explicar a expectativa de vida do que o modelo anterior que ajustamos para a taxa de mortalidade infantil? Por quê?\n\n## Links citados na aula\n\n- [Pacote performance](https://easystats.github.io/performance/articles/check_model.html): funções para avaliar o ajuste de modelos de regressão, visualizar diagnósticos e comparar modelos.\n\n- [Pacote modelsummary](https://modelsummary.com/): para criar tabelas de regressão, que exportam para word.\n\n- [Pacote coefplot](https://cran.r-project.org/web/packages/coefplot/index.html): para visualizar os coeficientes do modelo de regressão linear.\n\n- [Tidymodels](https://www.tidymodels.org/packages/) - metapacote, segue uma filosofia similar ao pacote tidyverse, para quem tem interesse em *machine learning* no R.\n\n- [Livro R Packages](https://r-pkgs.org/) - para quem tem interesse em criar pacotes no R.\n\n- Livro \"Uma senhora toma chá...: Como a estatística revolucionou a ciência no século XX\" - David Salsburg\n\n\n## Sugestões de materiais\n\n- [Livro *Introduction to Modern Statistics*](https://openintro-ims.netlify.app) de Mine Çetinkaya-Rundel e Johanna Hardin. \n  - [Regressão linear simples](https://openintro-ims.netlify.app/model-slr)\n  - [Regressão linear múltipla](https://openintro-ims.netlify.app/model-mlr)\n  \n  \n- [Introduction to Econometrics with R](https://www.econometrics-with-r.org/) - conteúdo mais avançado, para quem tem experiência em econometria."},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":true,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"toc-depth":5,"output-file":"08_regressao_linear.html"},"language":{"toc-title-document":"Índice","toc-title-website":"Nesta página","related-formats-title":"Outros formatos","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Fonte","other-links-title":"Outros Links","code-links-title":"Ligações de código","launch-dev-container-title":"Iniciar Dev Container","launch-binder-title":"Iniciar Binder","article-notebook-label":"Caderno do Artigo","notebook-preview-download":"Baixar Caderno","notebook-preview-download-src":"Descarregar código fonte","notebook-preview-back":"Voltar ao Artigo","manuscript-meca-bundle":"Arquivo MECA","section-title-abstract":"Resumo","section-title-appendices":"Apêndices","section-title-footnotes":"Notas de rodapé","section-title-references":"Referências","section-title-reuse":"Reuso","section-title-copyright":"Direito autoral","section-title-citation":"Citação","appendix-attribution-cite-as":"Por favor, cite este trabalho como:","appendix-attribution-bibtex":"BibTeX","appendix-view-license":"Ver Licença","title-block-author-single":"Autor","title-block-author-plural":"Autores","title-block-affiliation-single":"Afiliação","title-block-affiliation-plural":"Afiliações","title-block-published":"Data de Publicação","title-block-modified":"Data de Modificação","title-block-keywords":"Palavras-chave","callout-tip-title":"Dica","callout-note-title":"Nota","callout-warning-title":"Aviso","callout-important-title":"Importante","callout-caution-title":"Cuidado","code-summary":"Código","code-tools-menu-caption":"Código","code-tools-show-all-code":"Mostrar o código","code-tools-hide-all-code":"Esconder o código","code-tools-view-source":"Ver o código fonte","code-tools-source-code":"Código fonte","tools-share":"Share","tools-download":"Download","code-line":"Linha","code-lines":"Linhas","copy-button-tooltip":"Copiar para a área de transferência","copy-button-tooltip-success":"Copiada","repo-action-links-edit":"Editar essa página","repo-action-links-source":"Ver o código fonte","repo-action-links-issue":"Criar uma issue","back-to-top":"De volta ao topo","search-no-results-text":"Nenhum resultado","search-matching-documents-text":"documentos correspondentes","search-copy-link-title":"Copiar link para a busca","search-hide-matches-text":"Esconder correspondências adicionais","search-more-match-text":"mais correspondência neste documento","search-more-matches-text":"mais correspondências neste documento","search-clear-button-title":"Limpar","search-text-placeholder":"","search-detached-cancel-button-title":"Cancelar","search-submit-button-title":"Enviar","search-label":"Procurar","toggle-section":"Alternar seção","toggle-sidebar":"Alternar barra lateral","toggle-dark-mode":"Alternar modo escuro","toggle-reader-mode":"Alternar modo de leitor","toggle-navigation":"Alternar de navegação","crossref-fig-title":"Figura","crossref-tbl-title":"Tabela","crossref-lst-title":"Listagem","crossref-thm-title":"Teorema","crossref-lem-title":"Lema","crossref-cor-title":"Corolário","crossref-prp-title":"Proposição","crossref-cnj-title":"Conjetura","crossref-def-title":"Definição","crossref-exm-title":"Exemplo","crossref-exr-title":"Exercício","crossref-ch-prefix":"Capítulo","crossref-apx-prefix":"Apêndice","crossref-sec-prefix":"Seção","crossref-eq-prefix":"Equação","crossref-lof-title":"Lista de Figuras","crossref-lot-title":"Lista de Tabelas","crossref-lol-title":"Lista de Listagens","environment-proof-title":"Comprovação","environment-remark-title":"Comentário","environment-solution-title":"Solução","listing-page-order-by":"Ordenar por","listing-page-order-by-default":"Pré-selecionado","listing-page-order-by-date-asc":"Mais velho","listing-page-order-by-date-desc":"O mais novo","listing-page-order-by-number-desc":"Decrescente","listing-page-order-by-number-asc":"Crescente","listing-page-field-date":"Data","listing-page-field-title":"Título","listing-page-field-description":"Descrição","listing-page-field-author":"Autor","listing-page-field-filename":"Nome do arquivo","listing-page-field-filemodified":"Arquivo modificado","listing-page-field-subtitle":"Subtítulo","listing-page-field-readingtime":"Tempo de leitura","listing-page-field-wordcount":"Contagem de Palavras","listing-page-field-categories":"Categorias","listing-page-minutes-compact":"{0} minutos","listing-page-category-all":"Tudo","listing-page-no-matches":"Nenhum item correspondente","listing-page-words":"{0} palavras","listing-page-filter":"Filtro","draft":"Rascunho"},"metadata":{"lang":"pt","fig-responsive":true,"quarto-version":"1.5.57","page-navigation":true,"page-footer":{"border":true,"left":"Copyright 2024, Beatriz Milz e IPEA/COCD","right":[{"icon":"github","href":"https://github.com/ipeadata-lab/curso_r_intro_202409s"}]},"bibliography":["references.bib"],"editor":"source","theme":"cosmo","title":"Regressão linear","code-annotations":"hover"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}